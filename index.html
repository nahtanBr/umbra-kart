<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RoadFury</title>
<style>
  :root{
    --bg:#7f1d1d; --bg2:#000;
    --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.15);
    --txt:#e5e7eb; --muted:#cbd5e1; --rad:14px; --pad:12px; --gap:12px; --gap-sm:8px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto; color:var(--txt);
       background:linear-gradient(to bottom,var(--bg),var(--bg2))}
  .container{max-width:1200px;margin:0 auto;padding:var(--pad);display:grid;gap:var(--gap)}
  header{display:flex;align-items:center;justify-content:space-between;gap:var(--gap)}
  .space{display:flex;justify-content:space-between;align-items:center;gap:var(--gap-sm)}
  .flex{display:flex;gap:var(--gap-sm);align-items:center}
  .grid{display:grid;gap:var(--gap-sm)}
  .grid-2{display:grid;gap:var(--gap-sm);grid-template-columns:1fr 1fr}
  .row{display:grid;gap:var(--gap);grid-template-columns:1fr 1fr 1fr}
  @media (max-width:980px){ .row{grid-template-columns:1fr 1fr} }
  @media (max-width:700px){ .row{grid-template-columns:1fr} }
  h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--rad);padding:var(--pad)}
  .title{margin:0 0 6px 0;font-weight:700;font-size:14px}
  .btn{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.10);color:var(--txt);
       padding:8px 11px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn.primary{background:linear-gradient(to bottom right,#fecaca,#fcd34d);color:#111;border:none}
  .btn.sm{padding:6px 9px;border-radius:9px;font-size:13px}
  input,select,textarea{width:100%;background:rgba(0,0,0,.30);color:var(--txt);border:1px solid var(--border);
                        border-radius:10px;padding:8px 11px;outline:none;font-size:14px}
  .list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
  .scroll{max-height:240px;overflow:auto;padding-right:4px;-webkit-overflow-scrolling:touch}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.14);font-size:12px}
  .color-swatch{width:22px;height:22px;border-radius:6px;border:2px solid transparent;cursor:pointer}
  .color-swatch.active{border-color:#fff}
  .nota{white-space:pre-wrap; word-break:break-word; font-size:12px; margin-top:4px}
  .gearbar .btn{min-width:40px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>RoadFury</h1>
      </div>
      <div class="flex" style="gap:12px">
        <div id="colorPalette" class="flex"></div>
        <label class="flex" style="font-size:13px;gap:6px">
          <input id="soundToggle" type="checkbox" style="width:auto" checked/>
          üîä Sonido
        </label>
      </div>
    </header>

    <div class="row">
      <!-- Columna 1: √Årbitro -->
      <section class="card grid">
        <div class="space">
          <h2 class="title">Modo √Årbitro y fases</h2>
          <label class="flex" style="font-size:13px">
            <input id="arbToggle" type="checkbox" checked style="width:auto"/> Activado
          </label>
        </div>
        <div class="grid-2">
          <label>Jugadores <input id="totalPlayers" type="number" min="1" value="6"/></label>
          <label>Posici√≥n <input id="position" type="number" min="1" value="3"/></label>
        </div>
        <div class="grid-2">
          <div>Mazo sugerido <div id="deckSuggested" class="pill" style="margin-top:4px">delanteros</div></div>
          <div>Fase: <b id="phaseLabel">reponer</b></div>
        </div>
        <div class="space">
          <div class="flex">
            <button id="nextPhaseBtn" class="btn sm">Siguiente fase</button>
            <button id="resetTurnBtn" class="btn sm">Reiniciar</button>
          </div>
        </div>
      </section>

      <!-- Columna 2: Jugador + Dados -->
      <section class="card grid" id="playerCard">
        <div class="space">
          <div class="flex" style="gap:10px">
            <img id="playerCarIcon" src="img/autos/trash.png" alt="car icon" style="wmax-width:100%; height:200px; object-fit:contain;border-radius:6px"/>
            <span id="carName" style="font-weight:700;font-size:16px">Trash</span>
            <span id="fcBadge" class="pill">OK</span>
          </div>
          <button id="fcBtn" class="btn sm">FC</button>
        </div>

        <div class="space">
          <h2 class="title">Marcha actual</h2>
          <div class="muted">Bonificador: <b id="bonifLabel">+0</b></div>
        </div>
        <div id="gearBtns" class="flex gearbar" style="flex-wrap:wrap"></div>

        <div class="grid" style="gap:12px">
          <div class="grid-2" style="align-items:start">
            <div class="grid">
              <div class="title">Lanzar 2d6 + bonif</div>
              <button id="roll2d6Btn" class="btn primary">Lanzar 2d6</button>
            </div>
            <div class="grid">
              <div class="space">
                <div class="title">Tiradas</div>
                <div class="flex">
                  <label class="flex" style="gap:6px">Dados
                    <select id="diceCount" style="width:70px">
                      <option value="1">1</option>
                      <option value="2" selected>2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                    </select>
                  </label>
                  <button id="rollGenericBtn" class="btn sm">Tirar</button>
                </div>
              </div>
              <ul id="diceLog" class="list scroll"></ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Columna 3: Poderes + Historial -->
      <div class="grid">
        <section class="card grid">
          <div class="space">
            <h2 class="title">Poderes</h2>
            <div class="flex">
              <button id="drawSuggestedBtn" class="btn sm">Robar ‚Äî sugerido</button>
              <button id="discardHandBtn" class="btn sm">Descartar</button>
            </div>
          </div>

          <div class="grid">
            <div class="title">En mano</div>
            <ul id="handList" class="list scroll"></ul>
          </div>

          <div class="grid">
            <div class="title">Activo</div>
            <ul id="activeList" class="list scroll"></ul>
          </div>
        </section>

        <section class="card">
          <h2 class="title">Historial</h2>
          <ul id="history" class="list scroll"></ul>
        </section>
      </div>
    </div>
  </div>
  <!-- Modal selecci√≥n de poder (Carro√±ero) -->
<div id="selectModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50">
  <div class="card" style="width:min(520px,94vw)">
    <div class="space" style="margin-bottom:8px">
      <h2 class="title">Elige un poder</h2>
      <button id="selCloseBtn" class="btn sm">Cancelar</button>
    </div>
    <div class="grid">
      <label>Filtro por nombre
        <input id="selFilter" type="text" placeholder="Escribe para filtrar‚Ä¶"/>
      </label>
      <label>Cat√°logo
        <select id="selPower" size="8" style="width:100%"></select>
      </label>
      <div class="space">
        <span class="muted" id="selNota" style="min-height:1.4em"></span>
        <button id="selTakeBtn" class="btn primary">Tomar poder</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =============== Config general / utilidades =============== */
const ASSETS_VERSION = 'v8';
const asset = (p)=> `${p}?${ASSETS_VERSION}`;
function slug(s){
  return s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
}

/* =============== Colores ‚Üí autos e im√°genes =============== */
const COLOR_OPTIONS = [
  "#0f172a", // trash
  "#1d4ed8", // pinion
  "#047857", // engine
  "#facc15", // oxide (amarillo)
  "#ffffff", // scorch (blanco)
  "#581c87", // spikes
  "#14532d", // rogue
  "#7f1d1d", // crusher
  "#312e81", // ashes
  "#1f2937"  // fang
];
const COLOR_TO_CAR_KEY = {
  "#0f172a": "trash",
  "#1d4ed8": "pinion",
  "#047857": "engine",
  "#facc15": "oxide",
  "#ffffff": "scorch",
  "#581c87": "spikes",
  "#14532d": "rogue",
  "#7f1d1d": "crusher",
  "#312e81": "ashes",
  "#1f2937": "fang"
};
const CAR_LABEL = {
  trash:"Trash", pinion:"Pinion", engine:"Engine", oxide:"Oxide", scorch:"Scorch",
  spikes:"Spikes", rogue:"Rogue", crusher:"Crusher", ashes:"Ashes", fang:"Fang"
};
function renderPalette(sel){
  const pal=document.getElementById("colorPalette"); pal.innerHTML="";
  COLOR_OPTIONS.forEach(c=>{
    const b=document.createElement("button");
    b.className="color-swatch"+(c===sel?" active":"");
    b.style.background=c; b.onclick=()=>setTheme(c);
    pal.appendChild(b);
  });
}
function setTheme(c){
  document.body.style.background = `linear-gradient(to bottom, ${c}, #000)`;
  state.color = c;
  const key = COLOR_TO_CAR_KEY[c] || "trash";
  const label = CAR_LABEL[key] || "Car";
  document.getElementById("heroCar").src = asset(`img/autos/${key}.png`);
  document.getElementById("playerCarIcon").src = asset(`img/autos/${key}.png`);
  document.getElementById("carName").textContent = label;
  renderPalette(c);
}

/* =============== Cat√°logo apocal√≠ptico con im√°genes =============== */
const CATALOG_BASE = [
  { id:"escudo-1", nombre:"Ca√±er√≠a oxidada", deck:"ambos", tokens:1,
    nota:"Viaja en l√≠nea recta 12 casillas por turno hasta centrifugarse. Sirve como escudo. CAUSA FC.",
    copias_delanteros:3, copias_rezagados:3, image:"img/powerups/caneria-oxidada.png" },
  { id:"escudo-1x3", nombre:"Cohete casero", deck:"ambos", tokens:1,
    nota:"12 casillas por turno Busca al jugador m√°s cercano e ignora centr√≠fuga. Sirve como escudo. CAUSA FC.",
    copias_delanteros:2, copias_rezagados:2, image:"img/powerups/cohete-casero.png" },
  { id:"escudo-3", nombre:"llanta con puas", deck:"ambos", tokens:3,
    nota:"12 casillas por turno Busca al jugador m√°s cercano e ignora centr√≠fuga. Sirve como escudo. CAUSA FC.",
    copias_delanteros:2, copias_rezagados:2, image:"img/powerups/llanta-con-puas.png" },
  { id:"escudo-3x3", nombre:"Cohete no guiado", deck:"rezagados", tokens:3,
    nota:"Viaja en l√≠nea recta 12 casillas por turno hasta centrifugarse. Sirve como escudo. CAUSA FC.",
    copias_delanteros:0, copias_rezagados:3, image:"img/powerups/cohetes-no-guiados.png" },
  { id:"carronero", nombre:"Carro√±ero", deck:"rezagados", tokens:1,
    nota:"Roba 1 carta de la mano de un rival.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/carronero.png" },
  { id:"bomba", nombre:"Barril explosivo", deck:"ambos", tokens:2,
    nota:"Dos tokens de turno; explota manualmente o al agotarse (radio 2). CAUSA FC.",
    copias_delanteros:2, copias_rezagados:2, image:"img/powerups/barril-explosivo.png" },
  { id:"plantaF", nombre:"lanza llamas", deck:"rezagados", tokens:3,
    nota:"Tres tokens. Tira 2d6 + bonif. Debe gastarse en un solo turno en cualquier direcci√≥n. CAUSA FC.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/lanza-llamas.png" },
  { id:"boomerang", nombre:"Rafaga de tuercas", deck:"rezagados", tokens:3,
    nota:"Tres tokens. Avanza 5 casillas hacia adelante (s√≥lo adelante) y regresa por la misma trayectoria. CAUSA FC.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/rafaga-de-tuercas.png" },
  { id:"calamar", nombre:"Humo t√≥xico", deck:"ambos", tokens:1,
    nota:"Afecta a todos los rivales, les sube dos marchas(no afecta a Bala o Estrella). Impide bajar marcha al final del turno.",
    copias_delanteros:2, copias_rezagados:2, image:"img/powerups/humo-toxico.png" },
  { id:"champi", nombre:"Nitro casero", deck:"rezagados", tokens:1,
    nota:"Al activar: +2 marchas y duplica bonif o el mayor dado (a elecci√≥n). Si estrella durante su uso, causa FC.",
    copias_delanteros:5, copias_rezagados:3, image:"img/powerups/nitro-casero.png" },
  { id:"champix3", nombre:"Bidones de nitro x3", deck:"ambos", tokens:3,
    nota:"Tres usos del nitro. Puede causar FC al estrellar.",
    copias_delanteros:1, copias_rezagados:3, image:"img/powerups/bidones-nitro.png" },
  { id:"estrella", nombre:"Monster Truck", deck:"ambos", tokens:1,
    nota:"+2 marchas. No tira dados: avanza 12 + bonif. Si estrella, causa FC (2 tokens de turno) ignora centrifuga.",
    copias_delanteros:1, copias_rezagados:2, image:"img/powerups/monster-truck.png" },
  { id:"bala", nombre:"Carro blindado con taladro", deck:"rezagados", tokens:2,
    nota:"+1 marcha al activar. No tira dados: avanza 12 + bonif; ignora centr√≠fuga (en curva carril 3).",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/carro-blindado-taladro.png" },
  { id:"ampli", nombre:"Granada EMP", deck:"ambos", tokens:"instant",
    nota:"Instant√°neo (radio 3): desplaza 2 casillas a rivales y reduce 2 marchas (m√≠n 1¬™).",
    copias_delanteros:2, copias_rezagados:2, image:"img/powerups/emp-granada.png" },
  { id:"champi-dorado", nombre:"Turbina experimental", deck:"rezagados", tokens:1,
    nota:"+2 marchas. Relanza mientras salgan dados >2 (todo cuenta como un solo lanzamiento; ignora derrape). Si estrella, causa FC.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/turbina-experimental.png" },
  { id:"planta", nombre:"Motosierra montada", deck:"rezagados", tokens:1,
    nota:"Ataca adyacentes durante el avance. Ignora escudos y puede causar FC.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/motosierra-montada.png" },
  { id:"caparazon-azul", nombre:"Drone perseguidor", deck:"rezagados", tokens:1,
    nota:"Persigue al l√≠der; avanza 12 + bonif (en curva cuenta como carril 2). Causa FC al impactar.",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/dron-explosivo.png" },
  { id:"rayo", nombre:"Tormenta el√©ctrica", deck:"rezagados", tokens:2,
    nota:"(1) Todos FC. (2) Nadie sube de 1¬™ ni lanza poderes (no afecta a Monster Truck o Carro blindado).",
    copias_delanteros:0, copias_rezagados:2, image:"img/powerups/tormenta-electrica.png" },
  { id:"banana", nombre:"Trampa de clavos", deck:"ambos", tokens:1,
    nota:"Se lanza al frente con 2d6 (toma el mayor) o se deja atr√°s. Quien pisa pierde 2 marchas y se detiene. Escudo.",
    copias_delanteros:5, copias_rezagados:2, image:"img/powerups/trampa-de-clavos.png" },
  { id:"banana3", nombre:"Campo minado", deck:"ambos", tokens:3,
    nota:"Versi√≥n de 3 usos de trampa. Sirve como escudo.",
    copias_delanteros:5, copias_rezagados:2, image:"img/powerups/campo-minado.png" },
  { id:"torreta", nombre:"Torreta autom√°tica", deck:"ambos", tokens:2,
    nota:"Coloca torreta fija que dispara a rivales cercanos causa fc a todo rival que este a 2 o menos.",
    copias_delanteros:1, copias_rezagados:1, image:"img/powerups/torreta-automatica.png" },
  { id:"aceite", nombre:"Aceite incendiario", deck:"ambos", tokens:1,
    nota:"Deja un charco que enciende y retrasa a quien lo pisa mueve dos casillas horizontalmente y baja todas las marchas.",
    copias_delanteros:1, copias_rezagados:1, image:"img/powerups/aceite-incendiario.png" }
];
const DEFAULT_COUNTS = Object.fromEntries(
  CATALOG_BASE.map(p => [p.id, {delanteros: p.copias_delanteros, rezagados: p.copias_rezagados}])
);

/* =============== Estado y helpers =============== */
const bonifs={1:0,2:1,3:2,4:3,5:4,6:5};
const state={
  marcha:1, fc:false,
  jugadoresTotal:6,posicionActual:3,fase:"reponer",modoArbitro:true,
  mano:[],activos:[],counts:DEFAULT_COUNTS,catalog:CATALOG_BASE,
  diceCount:2,diceLog:[],hist:[],color:"#7f1d1d", muted:false
};
const el=(id)=>document.getElementById(id);
function pushHist(msg){ state.hist.unshift(new Date().toLocaleTimeString()+" ‚Äî "+msg); renderHistory(); }
function pushDice(msg){ state.diceLog.unshift(msg); renderDiceLog(); }
function sugerirDeck(pos,total){ return pos<=Math.floor(total/2) ? "delanteros" : "rezagados"; }
function rollDie(s){ return 1 + Math.floor(Math.random()*s); }
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Modal para Carro√±ero ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const selModal = document.getElementById("selectModal");
const selCloseBtn = document.getElementById("selCloseBtn");
const selFilter = document.getElementById("selFilter");
const selPower = document.getElementById("selPower");
const selNota = document.getElementById("selNota");
const selTakeBtn = document.getElementById("selTakeBtn");

function openCarroneroPicker(){
  // construimos opciones (excluye al propio Carro√±ero)
  const pool = state.catalog.filter(p => p.id !== "carronero");
  selFilter.value = "";
  buildSelList(pool);
  selNota.textContent = "";
  selModal.style.display = "flex";

  // listeners
  selFilter.oninput = () => {
    const q = selFilter.value.trim().toLowerCase();
    const filtered = pool.filter(p => (p.nombre || "").toLowerCase().includes(q));
    buildSelList(filtered);
  };
  selPower.onchange = () => {
    const p = getSelectedFromSel(pool);
    selNota.textContent = p ? (p.nota || "") : "";
  };
  selTakeBtn.onclick = () => {
    const p = getSelectedFromSel(pool);
    if(!p) return;
    // otorgar a la mano (si ya hay algo, lo sustituimos para cumplir ‚Äúm√°x 1 en mano‚Äù)
    state.mano = [p];
    pushHist(`Carro√±ero elige: ${p.nombre}`);
    renderPowers();
    closeCarroneroPicker();
  };
  selCloseBtn.onclick = closeCarroneroPicker;
  selModal.onclick = (e)=>{ if(e.target === selModal) closeCarroneroPicker(); };
}
function closeCarroneroPicker(){
  selModal.style.display = "none";
}
function buildSelList(arr){
  selPower.innerHTML = "";
  arr.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.nombre} ‚Äî ${p.deck} ¬∑ ${p.tokens==="instant"?"instant√°neo":p.tokens+" tok."}`;
    selPower.appendChild(opt);
  });
  if(arr.length){
    selPower.selectedIndex = 0;
    selNota.textContent = arr[0].nota || "";
  }else{
    selNota.textContent = "Sin resultados";
  }
}
function getSelectedFromSel(pool){
  const id = selPower.value;
  return pool.find(p => p.id === id) || null;
}


/* =============== Sonidos (parche universal m√≥vil/desktop) =============== */
let AUDIO_READY=false;
function makeSound(path){
  const a=new Audio(asset(path)); a.preload="auto";
  a.addEventListener("error", ()=>console.warn("‚ö†Ô∏è Audio no carg√≥:", a.src));
  try{ a.load(); }catch(_){}
  return a;
}
const SND={
  activate: makeSound("audio/game-start.mp3"),
  spend:    makeSound("audio/crash.mp3"),
  fc:       makeSound("audio/crash.mp3"),
  roll:     makeSound("audio/shift.mp3"),
  shift:    makeSound("audio/shift.mp3")
};
function primeSounds(){
  if(AUDIO_READY) return; AUDIO_READY=true;
  Object.values(SND).forEach(a=>{
    try{ a.play().then(()=>{a.pause();a.currentTime=0;}).catch(()=>{});}catch(_){}
  });
}
["pointerdown","touchstart","click"].forEach(ev=>document.addEventListener(ev, primeSounds, {once:true, passive:true}));
function playSnd(key){
  if(state.muted) return;
  primeSounds();
  const a=SND[key]; if(!a) return;
  try{ a.currentTime=0; a.play().catch(()=>{});}catch(_){}
}

/* =============== Render =============== */
function renderArb(){
  el("deckSuggested").textContent=sugerirDeck(state.posicionActual,state.jugadoresTotal);
  el("phaseLabel").textContent=state.fase;
  el("arbToggle").checked=state.modoArbitro;
}
function renderPlayer(){
  el("fcBadge").textContent = state.fc ? "FC (solo 1¬™)" : "OK";
  el("bonifLabel").textContent = (bonifs[state.marcha]>=0?"+":"")+bonifs[state.marcha];

  const wrap=el("gearBtns"); wrap.innerHTML="";
  const onlyInCierre = state.modoArbitro;              // con √Årbitro: s√≥lo CIERRE
  const canChange = onlyInCierre ? (state.fase === "cierre") : true;

  [1,2,3,4,5,6].forEach(g=>{
    const b=document.createElement("button");
    b.textContent=g+"¬™"; b.className="btn sm";
    let disabled=false;
    if (onlyInCierre && !canChange) disabled=true;        // √Årbitro ‚Üí s√≥lo CIERRE
    if (!onlyInCierre && state.fc && g!==1) disabled=true;// sin √Årbitro ‚Üí FC limita
    b.disabled = disabled;
    b.title = disabled
      ? (onlyInCierre ? "S√≥lo puedes cambiar marcha en CIERRE (√Årbitro)" : "En FC s√≥lo 1¬™")
      : ("Marcha "+g);
    if(state.marcha===g){ b.style.background="#fff"; b.style.color="#111"; }
    b.onclick=()=>{ if(!b.disabled){ const prev=state.marcha; state.marcha=g; renderPlayer(); if(prev!==g) playSnd("shift"); } };
    wrap.appendChild(b);
  });
}
function renderDiceLog(){
  const ul=el("diceLog"); ul.innerHTML="";
  if(!state.diceLog.length){ ul.innerHTML="<li class='muted'>‚Äî Sin tiradas ‚Äî</li>"; return; }
  state.diceLog.forEach(l=>{ const li=document.createElement("li"); li.textContent=l; ul.appendChild(li); });
}
function renderHistory(){
  const ul=el("history"); ul.innerHTML="";
  if(!state.hist.length){ ul.innerHTML="<li class='muted'>‚Äî Sin eventos ‚Äî</li>"; return; }
  state.hist.forEach(l=>{ const li=document.createElement("li"); li.textContent=l; ul.appendChild(li); });
}
function powerImgSrc(p){
  const candidate = p.image ? p.image : `img/powerups/${slug(p.nombre)}.png`;
  return asset(candidate);
}
const phSrc = asset('img/powerups/_placeholder.png');
function renderPowers(){
  // Mano
  const hand=el("handList"); hand.innerHTML="";
  if(!state.mano.length){
    hand.innerHTML="<li class='muted'>‚Äî Sin cartas ‚Äî</li>";
  } else {
    const p=state.mano[0];
    const src = powerImgSrc(p);
    hand.innerHTML = `<li class="card" style="padding:8px">
      <div class="space">
        <div class="flex" style="gap:10px;align-items:flex-start">
          <img src="${src}" alt="" style="width:44px;height:44px;object-fit:contain;border-radius:8px"
               onerror="this.onerror=null;this.src='${phSrc}'"/>
          <div>
            <div style="font-weight:700">${p.nombre}</div>
            <div class="muted">${p.deck} ¬∑ ${p.tokens==="instant"?"instant√°neo":(p.tokens+" token(s)")}</div>
            ${p.nota ? `<div class="nota">${p.nota}</div>` : ""}
          </div>
        </div>
        <button id="activateBtn" class="btn sm">Activar</button>
      </div>
    </li>`;
  el("activateBtn").onclick=()=>{
  const card = state.mano[0]; if(!card) return;
  playSnd("activate");
  // Caso especial: Carro√±ero
  if (card.id === "carronero") {
    // consumir el Carro√±ero (no queda activo), abrir selector
    state.mano = [];
    pushHist("Activado: Carro√±ero ‚Äî elige un poder del cat√°logo");
    renderPowers();
    openCarroneroPicker();
    return;
  }
  // Resto de poderes igual que antes:
  if(card.tokens === "instant"){
    pushHist(`Poder instant√°neo: ${card.nombre}`);
    state.mano = []; renderPowers(); return;
  }
  state.activos=[{power:card,tokensRestantes:Number(card.tokens)}];
  state.mano=[]; pushHist(`Activado: ${card.nombre} (${card.tokens} token${card.tokens===1?"":"s"})`);
  renderPowers();
};

  }
  // Activo
  const active=el("activeList"); active.innerHTML="";
  if(!state.activos.length){
    active.innerHTML="<li class='muted'>‚Äî Ninguno ‚Äî</li>";
  } else {
    const slot=state.activos[0];
    const src = powerImgSrc(slot.power);
    active.innerHTML = `<li class="card" style="padding:8px">
      <div class="space">
        <div class="flex" style="gap:10px;align-items:flex-start">
          <img src="${src}" alt="" style="width:44px;height:44px;object-fit:contain;border-radius:8px"
               onerror="this.onerror=null;this.src='${phSrc}'"/>
          <div>
            <div style="font-weight:700">${slot.power.nombre}</div>
            <div class="muted">${slot.tokensRestantes==null?"instant√°neo":(slot.tokensRestantes+" token(s) restantes")}</div>
            ${slot.power.nota ? `<div class="nota">${slot.power.nota}</div>` : ""}
          </div>
        </div>
        <div class="flex">
          ${slot.tokensRestantes!=null?`
            <button id="spend1Btn" class="btn sm">Gastar 1</button>
            <button id="spendAllBtn" class="btn sm">Gastar todos</button>`:""}
        </div>
      </div>
    </li>`;
    if(slot.tokensRestantes!=null){
      el("spend1Btn").onclick=spendOneToken;
      el("spendAllBtn").onclick=spendAllTokens;
    }
  }
}

/* =============== L√≥gica de juego: tokens, dados, mazos =============== */
function spendOneToken(){
  if(!state.activos.length) return;
  const slot = state.activos[0];
  if(slot.tokensRestantes == null) return;
  playSnd("spend");
  if(slot.tokensRestantes <= 1){
    pushHist(`Finaliza: ${slot.power.nombre}`);
    state.activos = [];
  } else {
    slot.tokensRestantes -= 1;
    pushHist(`Gastas 1 token de ${slot.power.nombre} ‚Üí quedan ${slot.tokensRestantes}`);
  }
  renderPowers();
}
function spendAllTokens(){
  if(!state.activos.length) return;
  const slot = state.activos[0];
  if(slot.tokensRestantes == null) return;
  playSnd("spend");
  pushHist(`Agotas todos los tokens de ${slot.power.nombre}`);
  state.activos = [];
  renderPowers();
}
function roll2d6(){
  if(state.fc){ pushHist("No puedes lanzar: FC"); return; }
  if(state.modoArbitro && state.fase!=="lanzar"){ pushHist("No es fase de lanzar"); return; }
  playSnd("roll");
  const d1=rollDie(6), d2=rollDie(6);
  const total = d1 + d2 + bonifs[state.marcha];
  const derrapes = [d1,d2].filter(v=>v===2||v===5).length; // +1D por cada 2 o 5
  pushHist(`2d6 (${d1}+${d2}) + bonif(${bonifs[state.marcha]}) = ${total}${derrapes?` ‚Üí Derrape +${derrapes}D`:""}`);
  pushDice(`Movimiento: ${total}${derrapes?` +${derrapes}D`:""}`);
}
function rollNd6(n){
  playSnd("roll");
  const vals=[]; for(let i=0;i<n;i++) vals.push(rollDie(6));
  const total=vals.reduce((a,b)=>a+b,0);
  pushHist(`${n}d6: ${vals.join(" + ")} = ${total}`);
  pushDice(`${n}d6: ${total}`);
}
function drawSuggested(){
  if(state.mano.length){ pushHist("Ya tienes carta en mano"); return; }
  const deck=sugerirDeck(state.posicionActual,state.jugadoresTotal); // "delanteros" / "rezagados"
  const pool=state.catalog.filter(p=>p.deck===deck || p.deck==="ambos");
  const total=pool.reduce((a,p)=>a+(state.counts[p.id]?.[deck]||0),0);
  if(total<=0){ pushHist("No hay cartas disponibles en el mazo sugerido"); return; }
  let r=Math.floor(Math.random()*total);
  for(const p of pool){
    r-=(state.counts[p.id]?.[deck]||0);
    if(r<0){
      state.mano=[p];
      pushHist(`Robas: ${p.nombre}${p.nota?(" ‚Äî "+p.nota):""}`);
      renderPowers();
      return;
    }
  }
}

/* =============== Eventos UI =============== */
document.getElementById("roll2d6Btn").onclick=roll2d6;
document.getElementById("rollGenericBtn").onclick=()=>rollNd6(state.diceCount);
document.getElementById("diceCount").onchange=()=>{ state.diceCount=+document.getElementById("diceCount").value; };

document.getElementById("fcBtn").onclick=()=>{
  state.fc=!state.fc;
  if(state.fc){ state.marcha=1; playSnd("fc"); }
  renderPlayer();
};
document.getElementById("arbToggle").onchange=()=>{ state.modoArbitro=document.getElementById("arbToggle").checked; renderPlayer(); };

document.getElementById("totalPlayers").oninput=()=>{ state.jugadoresTotal=Math.max(1,+document.getElementById("totalPlayers").value||1); renderArb(); };
document.getElementById("position").oninput=()=>{ state.posicionActual=Math.max(1,+document.getElementById("position").value||1); renderArb(); };

document.getElementById("nextPhaseBtn").onclick=()=>{
  const order=["reponer","accion1","lanzar","accion2","cierre"];
  state.fase=order[(order.indexOf(state.fase)+1)%order.length];
  renderArb(); renderPlayer();
};
document.getElementById("resetTurnBtn").onclick=()=>{ state.fase="reponer"; renderArb(); renderPlayer(); };

document.getElementById("drawSuggestedBtn").onclick=drawSuggested;
document.getElementById("discardHandBtn").onclick=()=>{ if(state.mano.length){ state.mano=[]; pushHist("Descartas la mano"); renderPowers(); } };

document.getElementById("soundToggle").onchange=(e)=>{
  state.muted = !e.target.checked; // ON por defecto
};

/* =============== Init =============== */
function renderAll(){
  renderPalette(state.color);
  const key = COLOR_TO_CAR_KEY[state.color] || "trash";
  document.getElementById("heroCar").src = asset(`img/autos/${key}.png`);
  document.getElementById("playerCarIcon").src = asset(`img/autos/${key}.png`);
  document.getElementById("carName").textContent = CAR_LABEL[key] || "Car";
  document.getElementById("soundToggle").checked = true; // sonido ON por defecto
  state.muted = false;
  renderPlayer(); renderArb(); renderPowers(); renderDiceLog(); renderHistory();
}
renderAll();
</script>
</body>
</html>
